// authService.js - Servicio de autenticaci√≥n
class UserAuthService {
    constructor() {
        this.API_BASE = 'http://localhost:8080/api/auth';
        this.currentUser = null;
        this.isAuthenticated = false;
        this.authCallbacks = [];
        this.sessionChecked = false;
        
        // Escuchar eventos de p√°gina para mantener sesi√≥n
        this.setupPageListeners();
        
        // Iniciar heartbeat para mantener sesi√≥n activa
        this.startSessionHeartbeat();
    }
    
    startSessionHeartbeat() {
        // Heartbeat temporalmente deshabilitado (modo mock)
        console.log('üíì Heartbeat temporalmente deshabilitado (modo mock)');
        /*
        // Verificar sesi√≥n cada 5 minutos
        setInterval(() => {
            if (this.isAuthenticated) {
                console.log('üíì Heartbeat: verificando sesi√≥n...');
                this.checkSessionSilently();
            }
        }, 5 * 60 * 1000); // 5 minutos
        */
    }
    
    setupPageListeners() {
        // Interceptar recargas y mantener sesi√≥n
        window.addEventListener('beforeunload', () => {
            if (this.isAuthenticated && this.currentUser) {
                // Forzar guardado en localStorage antes de recargar
                localStorage.setItem('user_backup', JSON.stringify({
                    user: this.currentUser,
                    timestamp: Date.now(),
                    authenticated: true
                }));
            }
        });
        
        // DESHABILITADO temporalmente: Interceptar cuando la p√°gina se vuelve visible
        // document.addEventListener('visibilitychange', () => {
        //     if (!document.hidden && this.isAuthenticated) {
        //         // Verificar sesi√≥n cuando la p√°gina vuelve a ser visible
        //         this.checkSessionSilently();
        //     }
        // });
    }
    
    async login(username, password) {
        try {
            // MODO MOCK para desarrollo sin backend
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('üîß Usando login mock para desarrollo...');
                // Simular delay de red
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Login mock - acepta cualquier usuario/contrase√±a para desarrollo
                if (username && password) {
                    this.currentUser = {
                        username: username,
                        fullName: `Usuario ${username}`,
                        email: `${username}@utp.edu.pe`,
                        role: 'ADMIN',
                        sessionId: 'mock-session-' + Date.now()
                    };
                    this.isAuthenticated = true;
                    
                    // Guardar en localStorage para persistencia
                    localStorage.setItem('user', JSON.stringify(this.currentUser));
                    
                    // Tambi√©n crear backup para recargas
                    localStorage.setItem('user_backup', JSON.stringify({
                        user: this.currentUser,
                        timestamp: Date.now(),
                        authenticated: true
                    }));
                    
                    this.notifyAuthChange();
                    return { success: true, user: this.currentUser };
                } else {
                    return { success: false, message: 'Usuario y contrase√±a son requeridos' };
                }
            }
            
            // LOGIN REAL para producci√≥n
            const response = await fetch(`${this.API_BASE}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.currentUser = {
                    username: data.username,
                    fullName: data.fullName,
                    role: data.role,
                    sessionId: data.sessionId
                };
                this.isAuthenticated = true;
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('user', JSON.stringify(this.currentUser));
                
                // Tambi√©n crear backup para recargas
                localStorage.setItem('user_backup', JSON.stringify({
                    user: this.currentUser,
                    timestamp: Date.now(),
                    authenticated: true
                }));
                
                this.notifyAuthChange();
                return { success: true, user: this.currentUser };
            } else {
                return { success: false, message: data.message };
            }
        } catch (error) {
            console.error('Error en login:', error);
            // Si hay error de conexi√≥n en desarrollo, usar login mock como fallback
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('üîß Fallback a login mock por error de conexi√≥n...');
                if (username && password) {
                    this.currentUser = {
                        username: username,
                        fullName: `Usuario ${username}`,
                        email: `${username}@utp.edu.pe`,
                        role: 'ADMIN',
                        sessionId: 'mock-session-' + Date.now()
                    };
                    this.isAuthenticated = true;
                    
                    localStorage.setItem('user', JSON.stringify(this.currentUser));
                    localStorage.setItem('user_backup', JSON.stringify({
                        user: this.currentUser,
                        timestamp: Date.now(),
                        authenticated: true
                    }));
                    
                    this.notifyAuthChange();
                    return { success: true, user: this.currentUser };
                }
            }
            return { success: false, message: 'Error de conexi√≥n' };
        }
    }
    
    async logout() {
        try {
            const response = await fetch(`${this.API_BASE}/logout`, {
                method: 'POST',
                credentials: 'include'
            });
            
            // Limpiar estado local independientemente de la respuesta del servidor
            this.currentUser = null;
            this.isAuthenticated = false;
            localStorage.removeItem('user');
            localStorage.removeItem('user_backup'); // Limpiar tambi√©n el backup
            
            this.notifyAuthChange();
            
            // Siempre retornar √©xito si se limpi√≥ el estado local
            return true;
        } catch (error) {
            console.error('Error en logout:', error);
            // Limpiar estado local incluso si hay error de conexi√≥n
            this.currentUser = null;
            this.isAuthenticated = false;
            localStorage.removeItem('user');
            localStorage.removeItem('user_backup');
            this.notifyAuthChange();
            // Retornar √©xito porque el estado local se limpi√≥ correctamente
            return true;
        }
    }
    
    async checkSession() {
        console.log('üîç Verificando sesi√≥n con servidor...');
        try {
            const response = await fetch(`${this.API_BASE}/me`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`Session check failed: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üì° Respuesta del servidor:', data);
            
            if (data.authenticated) {
                console.log('‚úÖ Sesi√≥n v√°lida en servidor para:', data.username);
                this.currentUser = {
                    username: data.username,
                    fullName: data.fullName,
                    email: data.email,
                    role: data.role
                };
                this.isAuthenticated = true;
                localStorage.setItem('user', JSON.stringify(this.currentUser));
                
                // Crear backup para recargas
                localStorage.setItem('user_backup', JSON.stringify({
                    user: this.currentUser,
                    timestamp: Date.now(),
                    authenticated: true
                }));
                
                this.notifyAuthChange();
                console.log('üîÑ Estado actualizado con datos del servidor');
            } else {
                console.log('‚ùå Servidor dice que no hay sesi√≥n v√°lida');
                this.clearSession();
            }
            
            return this.isAuthenticated;
        } catch (error) {
            console.error('‚ùå Error verificando sesi√≥n:', error);
            // En caso de error, mantener estado local si existe
            return this.isAuthenticated;
        }
    }
    
    // Verificaci√≥n silenciosa que no afecta la UI si hay errores de red
    async checkSessionSilently() {
        console.log('ü§´ Verificaci√≥n silenciosa de sesi√≥n...');
        try {
            const response = await fetch(`${this.API_BASE}/me`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.authenticated) {
                    console.log('‚úÖ Sesi√≥n confirmada silenciosamente');
                    // Actualizar datos si es necesario
                    if (!this.currentUser || this.currentUser.username !== data.username) {
                        this.currentUser = {
                            username: data.username,
                            fullName: data.fullName,
                            email: data.email,
                            role: data.role
                        };
                        this.isAuthenticated = true;
                        localStorage.setItem('user', JSON.stringify(this.currentUser));
                        this.notifyAuthChange();
                    }
                } else {
                    console.log('‚ùå Servidor confirma que no hay sesi√≥n v√°lida');
                    // Solo limpiar si estamos seguros de que el servidor dice que no hay sesi√≥n
                    this.clearSession();
                }
            } else {
                console.log('‚ö†Ô∏è Error en verificaci√≥n silenciosa, manteniendo estado actual');
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Error de red en verificaci√≥n silenciosa, manteniendo estado actual');
        }
    }
    
    clearSession() {
        this.currentUser = null;
        this.isAuthenticated = false;
        localStorage.removeItem('user');
        localStorage.removeItem('user_backup');
        this.notifyAuthChange();
    }
    
    async renewSession() {
        try {
            const response = await fetch(`${this.API_BASE}/renew`, {
                method: 'POST',
                credentials: 'include'
            });
            
            const data = await response.json();
            return data.success;
        } catch (error) {
            console.error('Error renovando sesi√≥n:', error);
            return false;
        }
    }
    
    getCurrentUser() {
        return this.currentUser;
    }
    
    isUserAuthenticated() {
        return this.isAuthenticated;
    }
    
    hasRole(role) {
        return this.currentUser && this.currentUser.role === role;
    }
    
    canAccess(requiredRoles) {
        if (!this.isAuthenticated) return false;
        if (!requiredRoles || requiredRoles.length === 0) return true;
        return requiredRoles.includes(this.currentUser.role);
    }
    
    // Sistema de callbacks para notificar cambios de autenticaci√≥n
    onAuthChange(callback) {
        this.authCallbacks.push(callback);
    }
    
    removeAuthCallback(callback) {
        this.authCallbacks = this.authCallbacks.filter(cb => cb !== callback);
    }
    
    notifyAuthChange() {
        this.authCallbacks.forEach(callback => {
            try {
                callback(this.isAuthenticated, this.currentUser);
            } catch (error) {
                console.error('Error en callback de autenticaci√≥n:', error);
            }
        });
    }
    
    // Utilidad para inicializar desde localStorage (para recarga de p√°gina)
    initFromStorage() {
        console.log('üîÑ Inicializando autenticaci√≥n desde localStorage...');
        
        // Primero intentar cargar desde el backup de recarga
        const backup = localStorage.getItem('user_backup');
        if (backup) {
            try {
                const backupData = JSON.parse(backup);
                const timeDiff = Date.now() - backupData.timestamp;
                
                // Si el backup es reciente (menos de 5 minutos)
                if (timeDiff < 5 * 60 * 1000 && backupData.authenticated) {
                    console.log('üîÑ Restaurando desde backup de recarga...');
                    this.currentUser = backupData.user;
                    this.isAuthenticated = true;
                    localStorage.setItem('user', JSON.stringify(this.currentUser));
                    localStorage.removeItem('user_backup');
                    this.notifyAuthChange();
                    
                    // Verificar en segundo plano pero no limpiar autom√°ticamente
                    setTimeout(() => this.checkSessionSilently(), 1000);
                    return;
                }
            } catch (error) {
                console.error('Error al restaurar backup:', error);
            }
            localStorage.removeItem('user_backup');
        }
        
        // Luego intentar cargar desde el localStorage normal
        const stored = localStorage.getItem('user');
        if (stored) {
            try {
                const user = JSON.parse(stored);
                console.log('‚úÖ Usuario encontrado en localStorage:', user.username);
                this.currentUser = user;
                this.isAuthenticated = true;
                this.notifyAuthChange();
                
                // Verificar que la sesi√≥n sigue siendo v√°lida en segundo plano
                setTimeout(() => {
                    console.log('üîç Verificando sesi√≥n en servidor...');
                    this.checkSessionSilently();
                }, 2000); // Aumentar tiempo de espera
            } catch (error) {
                console.error('‚ùå Error cargando usuario del storage:', error);
                localStorage.removeItem('user');
                this.checkSession();
            }
        } else {
            console.log('‚ùå No hay usuario en localStorage, verificando servidor...');
            // Si no hay usuario en localStorage, verificar si hay sesi√≥n en el servidor
            this.checkSession();
        }
    }
}

// Instancia global del servicio de autenticaci√≥n
const userAuthService = new UserAuthService();

// Auto-inicializar desde localStorage si existe y requerir login si no hay sesi√≥n
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM cargado, inicializando autenticaci√≥n...');
    
    // Inicializar inmediatamente
    userAuthService.initFromStorage();
    
    // Dar tiempo para verificaciones pero ser m√°s conservador
    setTimeout(() => {
        console.log('‚è∞ Verificando estado final de autenticaci√≥n...');
        console.log('Estado actual:', userAuthService.isAuthenticated ? 'Autenticado' : 'No autenticado');
        
        // Solo mostrar modal si definitivamente no hay sesi√≥n
        if (!userAuthService.isAuthenticated && !window.hasSessionData) {
            console.log('üîê Mostrando modal de login (no hay datos de sesi√≥n)...');
            // Asegurar que el modal de login se muestre
            if (window.authUI) {
                authUI.showLoginModal();
            } else {
                // Si authUI no est√° listo, esperar un poco m√°s
                setTimeout(() => {
                    if (window.authUI && !userAuthService.isAuthenticated) {
                        authUI.showLoginModal();
                    }
                }, 1000);
            }
        } else {
            console.log('‚úÖ Usuario ya autenticado o en proceso de verificaci√≥n');
        }
    }, 1500); // Reducir tiempo pero dar margen suficiente
});
